<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
	<head>
		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>  
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<script src="javascript/moduleinfo.js"></script>
		<script src="javascript/modulemapconfig.js"></script>
		<!--<script src="javascript/modulediscussion.js"></script>-->
		<script src="javascript/core.js"></script>
		<script src="javascript/helper.js"></script>
		<script src="javascript/querymanager.js"></script>
		<script src="javascript/modulemanager.js"></script>
		<link href="css/style.css" rel="stylesheet" type="text/css" />  
		<link rel="stylesheet" href="css/jquery-ui.css">
		<link href="css/dzl.css" rel="stylesheet" type="text/css" />  
		<style>
			.cellDiv
			{
				border:1px solid black;
				position:absolute;
				cursor:pointer;
				background-color:white;
			}
			.cellDiv:hover
			{
				background-color:yellow;
			}
			.columnDiv
			{
				width:200px;
				display:inline-flex;
				flex-direction:column;
				align-items:center;
				padding:10px;
				margin:10px;
			}
			.headingDiv
			{
				position:fixed;
				border:1px solid black;
				width:200px;
				background-color:white;
				z-index:100000;
			}
			#tooltipDiv
			{
				max-width:300px;
				z-index:100000;
			}
		</style>
		<script>
		$(document).ready(function(){
			QueryManager.useLocalFuseki();
			var queryString = (function () {/*
				PREFIX skos:    <http://www.w3.org/2004/02/skos/core#>
				PREFIX dc: 		<http://purl.org/dc/elements/1.1/>  
				PREFIX skos: 	<http://www.w3.org/2004/02/skos/core#>
				PREFIX snomed:  <http://purl.bioontology.org/ontology/SNOMEDCT/>
				PREFIX : 		<http://data.dzl.de/ont/dwh#>
				PREFIX rdf:		<http://www.w3.org/1999/02/22-rdf-syntax-ns#>
				PREFIX owl: 	<http://www.w3.org/2002/07/owl#>
				PREFIX foaf: 	<http://xmlns.com/foaf/0.1/>
				PREFIX xsd:		<http://www.w3.org/2001/XMLSchema#>
				PREFIX dc: 		<http://purl.org/dc/elements/1.1/>
				PREFIX dwh:    	<http://sekmi.de/histream/dwh#>
				PREFIX loinc: 	<http://loinc.org/owl#>
				PREFIX rdfs:	<http://www.w3.org/2000/01/rdf-schema#>
				PREFIX prov: 	<http://www.w3.org/ns/prov#>
				PREFIX cs:		<http://purl.org/vocab/changeset/schema#>
				SELECT ?commit ?message ?author ?startdate ?enddate (COUNT(distinct ?concept) as ?changes)
				WHERE
				{
					?commit a prov:Activity ;
						prov:wasAssociatedWith ?author ;
						prov:endedAtTime ?enddate ;
						prov:label ?message ;
					.
					optional { ?commit prov:startedAtTime ?startdate . }
					optional { ?commit cs:ChangeSet [ ?action [ rdf:Statement [ rdf:subject ?concept; rdf:predicate ?relation ] ] ] . }
					filter (?relation != skos:narrower)
				}
				GROUP BY ?commit ?author ?startdate ?enddate ?message
				order by desc(?enddate)
			*/}).toString().match(/[^]*\/\*([^]*)\*\/\}$/)[1];

			var fromDate = new Date("2018-01-01");
			var untilDate = new Date(Date.now());
			for (var date = untilDate; date >= fromDate; date.setMonth(date.getMonth() - 1))
			{
				var duration = Math.floor((Date.now()-date)/1000/60/60/24);
				var top = duration*10+50;
				var dateCell = $("<div class='cellDiv' style='left:0px;width:100%;margin-top:"+top+"px;border-left:0px;border-right:0px;border-bottom:0px'>"+date.toLocaleDateString("de-DE")+"</div>");
				$("#dateColumnDiv").append(dateCell);
			}
			QueryManager.query(queryString, function(r) { 
				var changes = r["changes"].value;
				if (changes > 0)
				{
					var author = r["author"].value.replace("http://data.dzl.de/ont/dwh#","");
					var commit_id = r["commit"].value.replace("http://data.dzl.de/ont/dwh#commit_","");
					var commit_message = r["message"].value;
					var authordiv;
					if ($("#provenance > #"+author).length == 0){
						authordiv=$("<div class='columnDiv' id="+author+"><div class='headingDiv'>"+author+"</div></div>");
						$("#provenance").append(authordiv);
					}
					else {
						authordiv=$("#provenance > #"+author+":first")
					}
					var start = r["startdate"]?new Date(r["startdate"].value):"";
					var end = new Date(r["enddate"].value);
					var now = Date.now();
					var duration = Math.floor((now-end)/1000/60/60/24);
					var size = Math.sqrt(changes*10)*5;
					var top = duration*10-size/2+50;
					var commit = $("<div class='cellDiv'"
						+ "style='width:"+size+"px;height:"+size+"px;margin-top:"+top+"px;border-radius:"+(size/2)+"px;z-index:"+(100000-changes)+"' "
						+ "tooltip='"+commit_id+"<br/>"+end.toLocaleDateString("de-DE")+"<br/>"+changes+" changes<br/>"+commit_message +"'></div>");
					authordiv.append(commit);
				}
			});
			
			
			$(this).bind("DOMSubtreeModified", function(e) {
				$(e.target).find("div").hover(
					function() {
						var tt = $( this ).attr("tooltip");
						if (tt != undefined)
						{
							var tooltip = $("#tooltipDiv");
							var scrollTop = $(window).scrollTop();
							tooltip.html(tt);
							tooltip.css("top", ($(this).offset().top - scrollTop - tooltip.outerHeight()) + "px");
							tooltip.css("left", ($(this).offset().left - tooltip.outerWidth()) + "px");
							tooltip.show();
						}
						var tt = $( this ).data("tooltip");
						if (tt != undefined)
						{
							var tooltip = $("#tooltipDiv");
							tooltip.html(tt($(this).data("tooltiparg")));
						}
					}, function() {
						$("#tooltipDiv").hide();
					}
				);
			});
		});
		</script>
	</head>
	<body>
		<div id="provenance" style="margin-left:400px">
			<div class='columnDiv' id='dateColumnDiv'>
			</div>
		</div>
		<div id='tooltipDiv'></div>
	</body>
</html>